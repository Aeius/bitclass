# Docker network - [참조](https://www.daleseo.com/docker-networks/)
Docker에서 네트워크를 구성하여 컨테이너 끼리 통신을 보다 쉽고 원할하게 할 수 있다.   
``` bash
docker network ls
```
![image](https://user-images.githubusercontent.com/87006912/225172950-f8f89402-638a-4131-a2c3-0e0aa2a8628d.png)   
기본적으로 3개의 네트워크가 존재하는데 기본값은 bridge에 묶이게 된다.(아마 보안때문에 서로 통신은 막혀있을 것)   
### 네트워크 생성
``` bash
docker network create group1
```
### mysql 생성 시 네트워크를 연결해줄 추가 명령어를 작성한다.
``` bash
docker run -it --rm -d -p 3306:3306 \
-e MYSQL_ROOT_PASSWORD=mysql \
-e MYSQL_DATABASE=lecture \
-e MYSQL_USER=scott -e MYSQL_PASSWORD=tiger \
--network group1 \
--name mysql8 \
-v dummySql:/var/lib/mysql mysql
```

### ubuntu 생성 시 같은 네트워크에 연결하여 mysql 컨테이너와 통신
``` bash
docker run -it --rm --network group1 61c4 /bin/bash

apt-get update
apt-get install iputils-ping
ping mysql8
```

### 정보확인 - 묶여있는 컨테이너들을 확인할 수 있다.
``` bash
docker network inspect group1
```

# Node.js
## Express Generator
npx는 일시적으로 다운받고 치우는 것 해당 프로젝트에만 적용,   
npm 이후 -g 옵션을 주면 글로벌 모드로 pc에 설치됨 글로벌 모드를 깔게 되면 이후 계속 업데이트를 해줘야함,   
--view=ejs를 해줘야 ejs환경으로 프로젝트를 생성해줌 -e로도 가능.   
``` bash
npx express-generator --view=ejs .

npm i nodemon
npm i mysql
```
![image](https://user-images.githubusercontent.com/87006912/225177059-aa07c7ff-4295-4946-9ba7-441ea1a4b5c6.png)   

### mysql DBCP (modules/mysql.js)
``` js
const mysql = require('mysql')
const pool = mysql.createPool({
  connectionLimit : 10,
  host: '192.168.99.100',
  user: 'scott',
  password: 'tiger',
  database: 'mydb'
})
module.exports = pool;
```
### routes/user.js
``` js
var express = require('express');
var router = express.Router();
var pool = require('../modules/mysql');

/* GET users listing. */
// 리스트
router.get('/', function(req, res, next) {
  const sql = "select * from dept";
  const query = pool.query(sql, (err,result,fields)=>{
    console.log(result);
    res.status(200).json(result);
});
/*  const query = pool.query(sql);
  query
    .on("error", function(err){
      console.log(err);
    })
    .on("result", function(row){
      console.log(row);
    })
    .on("end", function() {
      res.send('respond with a resource');
    });
}); */
// 입력
router.post('/', (req,res)=>{
  const deptno = req.body.deptno;
  const dname = req.body.dname;
  const loc = req.body.loc;
  const sql = `insert into dept value (${deptno}, '${dname}', '${loc}')`;
  pool.query(sql,(err)=>{
    if(err) return res.status(500).end();
    res.status(200).end();
  });
});

// 상세보기
router.get('/:deptno', (req,res) => {
  const deptno = req.params.deptno;
  const sql =`select * from dept where deptno=${deptno}`;
  const query = pool.query(sql);
  query
    .on("error", function(err){
      console.log(err);
    })
    .on("result", function(row){
      res.status(200).json(row);
    })
    .on("end", function() {

    });
 });

module.exports = router;
```

### [Express-Session](https://expressjs.com/en/resources/middleware/session.html) 를 이용한 로그인 처리
``` bash
npm install express-session
```
### routes/users.js
``` js
var session = require('express-session');
router.use(session({
  secret: 'keyboard cat',
  resave: false,
  saveUninitialized: true,
  cookie: {secure: true, maxAge : 60000} // secure를 true로 하면 쿠키가 보이지 않게됨
}))

// 가상 로그인 성공
router.get('/login', (req,res, next) =>{
  req.session.login = 'admin';
  res.status(200).end();
})

// 해당 파일의 모든 요청 로그인 여부 확인
// router.use('/',(req,res,nxt)=>{
//   if(req.session.login){
//     nxt();
//   } else {
//     res.status(403).end();
//   }
// });
// 원하는 곳에만 login 함수를 매개변수로 주게되면 여부확인됨
var login = (req,res,nxt)=>{
  if(req.session.login){
    nxt();
  } else {
    res.status(403).end();
  }
};

router.get('/', login, function(req, res, next) {
    const sql = "select * from dept";
    const query = pool.query(sql, (err,result,fields)=>{
      console.log(result);
      res.status(200).json(result);
    });
});
```
![image](https://user-images.githubusercontent.com/87006912/225189266-6645e649-a3fe-4830-895c-a239780ff993.png)   







































